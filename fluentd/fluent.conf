# Apache accesslog for webserver

<source>
  @type tail
  path /fluentd/log/access_log
  tag apache.access_log
  pos_file /fluentd/log/apache.pos
  <parse>
    @type regexp
    expression /^(?<host>[^ ]*) [^ ]* (?<user>[^ ]*) \[(?<time>[^\]]*)\] "(?<method>\S+)(?: +(?<path>[^ ]*) +\S*)?" (?<code>[^ ]*) (?<size>[^ ]*)(?: "(?<referer>[^\"]*)" "(?<agent>[^\"]*)")? "(?<x-mynavi-traceid>[^ ]*)" "(?<mynavi2020_tgk>[^ ]*)" (?<response_time>[^ ]*) (?<server_name>[^ ]*) "(?<x-bcc-clientdata>[^ ]*)"$/
   time_format %d/%b/%Y:%H:%M:%S %z 
  </parse>
</source>


#  Application Logs for apserver

<source>
  @type tail
  path /fluentd/log/application_log/*_student_std.*.log
  tag tomcat.application_std_log
  pos_file /fluentd/log/application_std.pos
  <parse>
    @type regexp
    expression /^(?<time>[^ ]* [^ ]*) (?<type>[^ ]*) (?<thread>[^ ]*) <TID:(?<TraceId>[^ ]*) TKID:(?<TrackingId>[^ ]*) IP:(?<IPaddress>[^ ]*) SID:(?<SessionId>[^ ]*) UID:(?<SystemId>[^ ]*) AUID:(?<AdminSystemId>.*?)> \[(?<LogLevel>INFO ?|ERROR ?|WARN ?)\] (?<messages>.*)$/
    time_format %Y-%m-%d %H:%M:%S.%L
  </parse>
</source>

# Catalina.out Logs for apserver

<source>
 @type tail
 path /fluentd/log/application_log/catalina.out*
 tag tomcat.catalina_log
 pos_file /fluentd/log/catalina.pos
 <parse>
   @type multiline
   format_firstline /\d{1,2}-\w{3}-\d{4}/
   format1 /^(?<time>[^ ]* [^ ]*) (?<LogLevel>[^ ]*) \[(?<Thead>[^ ]*)\] (?<Messages>.*)$/
   time_format %d-%b-%Y %H:%M:%S.%L
 </parse>
</source>


# Entry log for batchserver

<source>
  @type tail
  path /fluentd/log/entry_log
  tag batch.entry_log
  pos_file /fluentd/log/entry.pos
  <parse>
    @type csv
    keys time,PackableEntry,KobetsuEntry,SeminarEntry,OutsideEntry,EventEntry
    time_key time
    time_format %Y/%m/%d %H:%M:%S
  </parse>
</source>

# /var/log/messages for all server

<source>
  @type tail 
  path /fluentd/log/messages
  tag os.syslog
  pos_file /fluentd/log/os.pos
  <parse>
    @type syslog
  </parse>
</source>

<source>
  @type monitor_agent
  bind 0.0.0.0
  port 24220
</source>

<filter **.**>
  @type record_transformer
 <record>
   hostname "#{Socket.gethostname}"
   tag ${tag}
 </record>
</filter>

<match apache.**>
   @type elasticsearch
   host 54.238.155.92
   port 9200
   index_name apache_access
   type_name apache_access
  <buffer>
    @type file
    path /fluentd/log/apache.*.buffer
    chunk_limit_size 256MB
    total_limit_size 64GB
    flush_at_shutdown false
    flush_mode lazy
    flush_thread_count 4
    flush_thread_interval 1.0
    delayed_commit_timeout 60
    overflow_action throw_exception
    retry_timeout 72h
    retry_max_times 10
    retry_secondary_threshhold 0.8
  </buffer>
</match>

<match tomcat.**>
   @type elasticsearch
   host 54.238.155.92
   port 9200
   index_name fluentd.${tag}.%Y%m%d
   type_name tomcat_log
  <buffer>
    @type file
    path /fluentd/log/apache.*.buffer
    chunk_limit_size 256MB
    total_limit_size 64GB
    flush_at_shutdown false
    flush_mode lazy
    flush_thread_count 4
    flush_thread_interval 1.0
    delayed_commit_timeout 60
    overflow_action throw_exception
    retry_timeout 72h
    retry_max_times 10
    retry_secondary_threshhold 0.8
  </buffer>
</match>


<match batch.**>
   @type elasticsearch
   host 54.238.155.92
   port 9200
   index_name fluentd.${tag}.%Y%m%d
   type_name entry_log
  <buffer>
    @type file
    path /fluentd/log/apache.*.buffer
    chunk_limit_size 256MB
    total_limit_size 64GB
    flush_at_shutdown false
    flush_mode lazy
    flush_thread_count 4
    flush_thread_interval 1.0
    delayed_commit_timeout 60
    overflow_action throw_exception
    retry_timeout 72h
    retry_max_times 10
    retry_secondary_threshhold 0.8
  </buffer>
</match>

<match fluent.**>
  @type relabel
  @label @FLUENT_ERROR
</match>

<label @FLUENT_ERROR>
  <filter fluent.**>
    @type record_transformer
    enable_ruby
    <record>
      host "#{Socket.gethostname}"
      tag ${tag}
    </record>
  </filter>
  <filter **>
    @type suppress
    interval 10
    num 2
    attr_kys host,message
  </filter>
  <filter **> 
    @type grep 
    regexp1 tag, fluent.(warn|error|fatal)
    #exclude1 message somthing foo
  </filter>
  <match **>
   @type record_modifier
   tag app.fluentd
  </match>
</label>

<match app.fluentd>
  @type elasticsearch
   host 54.238.155.92
   port 9200
   index_name app_fluentd
   type_name app_fluentd
</match>
